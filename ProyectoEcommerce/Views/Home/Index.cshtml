@model IEnumerable<ProyectoEcommerce.Models.Product>
@using System.Globalization
@{
    ViewData["Title"] = "Home Page";
    var nf = new CultureInfo("es-CR").NumberFormat;
    nf.NumberDecimalDigits = 0;
}
@section Styles {
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/maps.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
}

<main class="main-content">
    <h1 class="section-title">Productos Destacados</h1>

    @if (Model != null && Model.Any())
    {
        var grouped = Model.Select((p, index) => new { p, index })
        .GroupBy(x => x.index / 3)
        .ToList();

        <div class="carousel-wrapper position-relative">
            <!-- Carrusel -->
            <div id="destacadosCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="6000">

                <!-- Indicadores -->
                <div class="carousel-indicators">
                    @for (var i = 0; i < grouped.Count; i++)
                    {
                        <button type="button" data-bs-target="#destacadosCarousel" data-bs-slide-to="@i"
                                class="@(i == 0 ? "active" : "")"
                                aria-current="@(i == 0 ? "true" : "false")"
                                aria-label="Slide @(i + 1)"></button>
                    }
                </div>

                <div class="carousel-inner">
                    @for (var i = 0; i < grouped.Count; i++)
                    {
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <div class="row justify-content-center">
                                @foreach (var item in grouped[i])
                                {
                                    var originalPrice = item.p.Price;
                                    var effectivePrice = item.p.EffectivePrice;
                                    var hasPromotion = item.p.Promotion != null
                                                        && item.p.Promotion.IsActive
                                                        && item.p.Promotion.StartDate <= DateTime.UtcNow
                                                        && item.p.Promotion.EndDate >= DateTime.UtcNow;
                                    <div class="col-md-3">
                                        <div class="product-card mb-4">
                                            <a asp-controller="Products" asp-action="DetailsPublic" asp-route-id="@item.p.Id" class="product-link">
                                                <div class="product-image position-relative">
                                                    @{
                                                        string imgSrc = string.Empty;
                                                        if (!string.IsNullOrEmpty(item.p.ImageUrl) &&
                                                        (item.p.ImageUrl.StartsWith("http://") || item.p.ImageUrl.StartsWith("https://")))
                                                        {
                                                            imgSrc = item.p.ImageUrl;
                                                        }
                                                        else if (!string.IsNullOrEmpty(item.p.ImageUrl))
                                                        {
                                                            var localPath = item.p.ImageUrl.StartsWith("~")
                                                            ? item.p.ImageUrl
                                                            : (item.p.ImageUrl.StartsWith("/") ? "~" + item.p.ImageUrl : "~/" + item.p.ImageUrl.TrimStart('/'));
                                                            imgSrc = Url.Content(localPath);
                                                        }
                                                        else
                                                        {
                                                            imgSrc = Url.Content("~/images/products/placeholder.jpg");
                                                        }
                                                    }

                                                    <img src="@imgSrc" alt="@item.p.Name" class="card-img" asp-append-version="true" loading="lazy" />
                                                    <div class="product-badge @(item.p.Available ? "available" : "unavailable")">
                                                        @(item.p.Available ? "Disponible" : "Agotado")
                                                    </div>

                                                    @* Badges de promoción *@
                                                    @if (hasPromotion)
                                                    {
                                                        <div class="promotion-badge badge bg-danger position-absolute top-0 start-0 ms-2 mt-2">
                                                            @item.p.Promotion.BadgeText ?? $"{item.p.Promotion.DiscountPercent}% OFF"
                                                        </div>
                                                    }
                                                </div>

                                                <div class="product-info-clickable text-center">
                                                    <h3 class="product-name">@item.p.Name</h3>
                                                    <p class="product-availability">
                                                        @(item.p.Available ? $"En stock ({item.p.Stock} unidades)" : "Sin stock")
                                                    </p>
                                                    <div class="product-price">
                                                        @if (effectivePrice < originalPrice)
                                                        {
                                                            <div>
                                                                <span class="text-decoration-line-through text-muted">₡@originalPrice.ToString("N0", nf)</span>
                                                                <br />
                                                                <strong>₡@effectivePrice.ToString("N0", nf)</strong>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <strong>₡@originalPrice.ToString("N0", nf)</strong>
                                                        }
                                                    </div>
                                                </div>
                                            </a>

                                            <div class="product-actions text-center">
                                                @if (item.p.Available && item.p.Stock > 0)
                                                {
                                                    <a asp-controller="Products" asp-action="DetailsPublic" asp-route-id="@item.p.Id" class="buy-btn">
                                                        Comprar Ahora
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="buy-btn disabled">Agotado</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Controles flotantes en capa externa -->
            <div class="carousel-controls-overlay">
                <button class="arrow-left" type="button" data-bs-target="#destacadosCarousel" data-bs-slide="prev" aria-label="Anterior">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="arrow-right" type="button" data-bs-target="#destacadosCarousel" data-bs-slide="next" aria-label="Siguiente">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    }
    else
    {
        <p class="text-muted">No hay productos destacados para mostrar.</p>
    }
</main>

<hr class="my-5" />

<img src="~/images/Logos/Whats.png" class="whatsapp-btn" title="Contactar por WhatsApp" />

<!-- Reseñas de usuarios -->
<section id="user-reviews" class="user-reviews-section container">
    <h2 class="reviews-title">Reseñas de clientes</h2>

    <div class="reviews-grid">
        <article class="review-card" tabindex="0" aria-labelledby="r1-name" aria-describedby="r1-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">AJ</div>
                <div class="review-meta">
                    <strong id="r1-name" class="review-name">Ana Jiménez</strong>
                    <div class="review-payment">Método: <span class="payment-method">Tarjeta de crédito</span></div>
                </div>
            </header>
            <div class="review-body" id="r1-text">
                <p>El producto llegó rápido y en perfecto estado. La atención al cliente resolvió mi duda en minutos. ¡Recomendado!</p>
            </div>
        </article>

        <article class="review-card" tabindex="0" aria-labelledby="r2-name" aria-describedby="r2-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">CR</div>
                <div class="review-meta">
                    <strong id="r2-name" class="review-name">Carlos Rodríguez</strong>
                    <div class="review-payment">Método: <span class="payment-method">PayPal</span></div>
                </div>
            </header>
            <div class="review-body" id="r2-text">
                <p>Buena relación precio-calidad. La garantía funcionó sin problemas. Volvería a comprar.</p>
            </div>
        </article>

        <article class="review-card" tabindex="0" aria-labelledby="r3-name" aria-describedby="r3-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">ML</div>
                <div class="review-meta">
                    <strong id="r3-name" class="review-name">María López</strong>
                    <div class="review-payment">Método: <span class="payment-method">Efectivo / Contra entrega</span></div>
                </div>
            </header>
            <div class="review-body" id="r3-text">
                <p>Muy contenta con la compra. El empaque estaba muy bien y las instrucciones claras.</p>
            </div>
        </article>
    </div>
</section>

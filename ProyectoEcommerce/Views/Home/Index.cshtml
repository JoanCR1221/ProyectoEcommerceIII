@model IEnumerable<ProyectoEcommerce.Models.Product>
@{
    ViewData["Title"] = "Home Page";
}
@section Styles {
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/maps.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
}


@section Scripts {
    <!-- API Key CORREGIDA y optimizada -->
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
                    @*script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyASg-6uv9BAJVu5haLhf3iimD8X1Xhnaas&callback=initMap';*@
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        window.onload = loadGoogleMaps;
    </script>
    <script src="~/js/maps.js" asp-append-version="true"></script>
}






<main class="main-content">
    <h1 class="section-title">Productos Destacados</h1>


    <!-- loop  que muestra los productos, crea una tarjeta para cada producto-->
    <div class="products-grid">
        @foreach (var item in Model)
        {
            <div class="product-card">
                <!-- Enlace que cubre solo la imagen y la info básica -->
                <a asp-controller="Products" asp-action="Details" asp-route-id="@item.Id" class="product-link">
                    <div class="product-image">
                        @{
                            // Decide la URL de la imagen: externa o local
                            string imgSrc = string.Empty;
                            if (!string.IsNullOrEmpty(item.ImageUrl) &&
                            (item.ImageUrl.StartsWith("http://") || item.ImageUrl.StartsWith("https://")))
                            {
                                imgSrc = item.ImageUrl; // URL externa
                            }
                            else if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                // Normaliza rutas locales: acepta "images/..." "/images/..." o "~/images/..."
                                var localPath = item.ImageUrl.StartsWith("~")
                                ? item.ImageUrl
                                : (item.ImageUrl.StartsWith("/") ? "~" + item.ImageUrl : "~/" + item.ImageUrl.TrimStart('/'));
                                imgSrc = Url.Content(localPath);
                            }
                            else
                            {
                                imgSrc = Url.Content("~/images/products/placeholder.jpg"); // placeholder --:genera un 404 () IMAGEN FANTASMA / ver en console de desarrollador...NO afecta 
                            }
                        }

                        @* Si la fuente es externa no podemos usar asp-append-version. Para local, sí. *@
                        @if (imgSrc.StartsWith("http"))
                        {
                            <img src="@imgSrc" alt="@item.Name" class="card-img" />
                        }
                        else
                        {
                            <img src="@imgSrc" alt="@item.Name" class="card-img" asp-append-version="true" />
                        }

                        <div class="product-badge @(item.Available ? "available" : "unavailable")">
                            @(item.Available ? "Disponible" : "Agotado")
                        </div>
                    </div>

                    <div class="product-info-clickable">
                        <h3 class="product-name">@item.Name</h3>
                        @* Si tienes categoría como propiedad, muéstrala. Si no, omítelo. *@
                        @* <p class="product-category">@item.Category</p> *@
                        <p class="product-availability">
                            <span class="status-indicator @(item.Available ? "" : "unavailable")"></span>
                            @(item.Available ? $"En stock ({item.Stock} unidades)" : "Sin stock")
                        </p>
                        <div class="product-price">@item.Price.ToString("C")</div>
                    </div>
                </a>

               
                <div class="product-actions">
                    @if (item.Available && item.Stock > 0)
                    {
                        <button type="button"
                                class="buy-btn"
                                onclick="addToCart(@item.Id, '@item.Name', @item.Price)"
                                data-product-id="@item.Id">
                            Comprar Ahora
                        </button>
                    }
                    else
                    {
                        <button type="button" class="buy-btn disabled" disabled>
                            Agotado
                        </button>
                    }
                </div>
            </div>
        }
    </div>

</main>

<img src="~/images/Logos/Whats.png" class="whatsapp-btn" title="Contactar por WhatsApp"></img>



<!-- Reseñas de usuarios ( guía visual — sin lógica ) -->
<section id="user-reviews" class="user-reviews-section container">
    <h2 class="reviews-title">Reseñas de clientes</h2>

    <div class="reviews-grid">
        <!-- Reseña 1 -->
        <article class="review-card" tabindex="0" aria-labelledby="r1-name" aria-describedby="r1-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">AJ</div>
                <div class="review-meta">
                    <strong id="r1-name" class="review-name">Ana Jiménez</strong>
                    <div class="review-payment">Método: <span class="payment-method">Tarjeta de crédito</span></div>
                </div>
            </header>
            <div class="review-body" id="r1-text">
                <p>El producto llegó rápido y en perfecto estado. La atención al cliente resolvió mi duda en minutos. ¡Recomendado!</p>
            </div>
        </article>

        <!-- Reseña 2 -->
        <article class="review-card" tabindex="0" aria-labelledby="r2-name" aria-describedby="r2-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">CR</div>
                <div class="review-meta">
                    <strong id="r2-name" class="review-name">Carlos Rodríguez</strong>
                    <div class="review-payment">Método: <span class="payment-method">PayPal</span></div>
                </div>
            </header>
            <div class="review-body" id="r2-text">
                <p>Buena relación precio-calidad. La garantía funcionó sin problemas. Volvería a comprar.</p>
            </div>
        </article>

        <!-- Reseña 3 -->
        <article class="review-card" tabindex="0" aria-labelledby="r3-name" aria-describedby="r3-text">
            <header class="review-header">
                <div class="review-avatar" aria-hidden="true">ML</div>
                <div class="review-meta">
                    <strong id="r3-name" class="review-name">María López</strong>
                    <div class="review-payment">Método: <span class="payment-method">Efectivo / Contra entrega</span></div>
                </div>
            </header>
            <div class="review-body" id="r3-text">
                <p>Muy contenta con la compra. El empaque estaba muy bien y las instrucciones claras.</p>
            </div>
        </article>
    </div>
</section>




<!-- Mapa + Sucursales -->
<section class="map-branches container" aria-label="Mapa y sucursales">
    <h2 class="section-title">ENCUÉNTRANOS</h2>

    <div class="map-branches-grid">
        <!-- Columna: Mapa -->
        <div class="map-column">
            <div class="map-wrapper" role="application" aria-label="Mapa de sucursales">
                <div id="map">
                    <div class="map-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Cargando mapa...</p>
                    </div>
                </div>
                <div class="map-actions">
                    <button id="locate-me">
                        <i class="fas fa-location-arrow"></i> Mi ubicación
                    </button>
                </div>
            </div>
        </div>

        <!-- Columna: Lista de sucursales -->
        <aside class="branches-column" aria-labelledby="branches-title">
            <h3 id="branches-title" class="branches-title">Sucursales disponibles</h3>

            <div class="branches-list">
                <!-- Sucursal 1 -->
                <article class="branch-card" tabindex="0" aria-labelledby="branch1-name"
                         data-lat="10.134533" data-lng="-85.446590" data-branch="central">
                    <div class="branch-header">
                        <strong id="branch1-name" class="branch-name">Sucursal Central - Nicoya</strong>
                        <span class="branch-distance">A 2.1 km</span>
                    </div>
                    <div class="branch-body">
                        <div class="branch-address">Av. Principal 123, Nicoya, Guanacaste</div>
                        <div class="branch-hours">Horario: Lun - Vie 8:00 - 17:00</div>
                        <div class="branch-phone">Tel: <a href="tel:+50612345678">+506 1234-5678</a></div>
                        <div class="branch-payment">Métodos: Tarjeta • Efectivo • PayPal</div>
                    </div>
                </article>

                <!-- Sucursal 2 -->
                <article class="branch-card" tabindex="0" aria-labelledby="branch2-name"
                         data-lat="10.140000" data-lng="-85.450000" data-branch="plaza">
                    <div class="branch-header">
                        <strong id="branch2-name" class="branch-name">Sucursal Plaza Oeste</strong>
                        <span class="branch-distance">A 12.5 km</span>
                    </div>
                    <div class="branch-body">
                        <div class="branch-address">Centro Comercial Plaza Oeste, Local 5</div>
                        <div class="branch-hours">Horario: Lun - Sab 9:00 - 18:00</div>
                        <div class="branch-phone">Tel: <a href="tel:+50687654321">+506 8765-4321</a></div>
                        <div class="branch-payment">Métodos: Tarjeta • PayPal</div>
                    </div>
                </article>

                <!-- Sucursal 3 -->
                <article class="branch-card" tabindex="0" aria-labelledby="branch3-name"
                         data-lat="10.120000" data-lng="-85.430000" data-branch="playa">
                    <div class="branch-header">
                        <strong id="branch3-name" class="branch-name">Punto Express - Playa</strong>
                        <span class="branch-distance">A 35 km</span>
                    </div>
                    <div class="branch-body">
                        <div class="branch-address">Ruta 21, Km 4, Local frente a la playa</div>
                        <div class="branch-hours">Horario: Mar - Dom 10:00 - 20:00</div>
                        <div class="branch-phone">Tel: <a href="tel:+50644556677">+506 4455-6677</a></div>
                        <div class="branch-payment">Métodos: Efectivo • Contra entrega</div>
                    </div>
                </article>
            </div>

            <!-- Barra de búsqueda -->
            <div class="search-box">
                <input type="text" id="branch-search" placeholder="Escribe aquí para buscar...">
                <i class="fas fa-search"></i>
            </div>
        </aside>
    </div>
</section>





<!--  script de diagnóstico 
<script>
    // Diagnóstico COMPLETO para encontrar la imagen fantasma
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔍 Búsqueda profunda de la imagen con src="/11"');

        // 1. Buscar en todo el DOM
        const allImages = document.querySelectorAll('img');
        let ghostImage = null;

        allImages.forEach(img => {
            if (img.src.includes('/11') || img.getAttribute('src') === '/11') {
                console.log('🚨 IMAGEN FANTASMA ENCONTRADA:', img);
                console.log('📍 Ubicación:', img.parentElement);
                console.log('🖼️ Src completo:', img.src);
                console.log('🏷️ Alt:', img.alt);
                console.log('🧩 HTML completo:', img.outerHTML);
                ghostImage = img;
            }
        });

        // 2. Si no se encuentra, podría ser dinámica
        if (!ghostImage) {
            console.log('⚠️ No encontrada en DOM inicial - puede ser dinámica');

            // Observar cambios en el DOM
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeName === 'IMG' &&
                            (node.src.includes('/11') || node.getAttribute('src') === '/11')) {
                            console.log('🚨 IMAGEN DINÁMICA ENCONTRADA:', node);
                            node.remove();
                        }
                    });
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });
        } else {
            
            ghostImage.src = '/images/placeholder.jpg';
            console.log('✅ Imagen problemática reemplazada');
        }

        // 4. Verificar también datos de productos
        console.log('📦 Revisando datos de productos...');
        const productCards = document.querySelectorAll('.product-card');
        productCards.forEach((card, index) => {
            const img = card.querySelector('img');
            if (img && img.src.includes('/11')) {
                console.log(`🚨 Producto ${index + 1} tiene imagen problemática`);
            }
        });
    });
</script> -->
